<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Detailed data analysis results, including dataset comparison, drift detection, and AI-powered insights.">
    <title>Analysis Results - Data Monitoring Tool</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" href="https://aionos.io/wp-content/uploads/2024/04/cropped-file-1-32x32.png">
</head>
<body>
    <header class="main-nav-container">
        <nav class="main-nav">
             <a href="{{ url_for('index') }}" class="nav-link">Run New Analysis</a>
             <a href="{{ url_for('analysis_logs') }}" class="nav-link">View All Logs</a>
        </nav>
    </header>

    <main class="container page-container results-container">
        <header class="page-header">
            <h1>Data Analysis Results</h1>
            {% if log_id and log_id != "N/A" and log_id is not none %}
                <p class="log-id-display"><strong>Analysis Log ID:</strong> <span class="log-id-value">{{ log_id }}</span></p>
            {% endif %}
        </header>
        <hr class="separator">

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <ul class="flashes" role="alert">
            {% for category, message in messages %}
              <li class="{{ category }}">{{ message }}</li>
            {% endfor %}
            </ul>
          {% endif %}
        {% endwith %}

        {% if is_direct_log_view %}
            {# Simplified view when coming directly from logs page #}
            <section class="card log-view-summary-card">
                <h2 class="card-title">Log Entry Details</h2>
                <p><strong>Timestamp:</strong> {{ timestamp if timestamp else 'N/A' }}</p>
                <p><strong>Status:</strong> <span class="status-badge {{ 'status-success' if status == 'Success' else ('status-warning' if 'Warning' in status or 'AI issue' in status else 'status-failure') }}">{{ status if status else 'N/A' }}</span></p>
                <p><strong>New Data File:</strong> {{ new_filename if new_filename else 'N/A' }}</p>
                {% if log_summary %}
                    <h4>Summary / Error:</h4>
                    <pre>{{ log_summary }}</pre>
                {% endif %}
                {% if report_content and "Critical Failure" in report_content %}
                     <div class="report-content-wrapper" style="margin-top:15px;">
                        {{ report_content|safe }}
                    </div>
                {% elif not report_content and not log_summary %}
                    <p><em>No detailed report or summary available for this log entry. It might be an older log or one that didn't complete fully.</em></p>
                {% endif %}
                 <p style="margin-top: 20px;"><a href="{{ url_for('analysis_logs') }}" class="nav-link-button">Back to All Logs</a></p>
            </section>

        {% elif report_content and ("Analysis Failed" in report_content or "Critical Analysis Error" in report_content or "Input Error" in report_content or "Runtime Error" in report_content) %}
             <section class="card error-card full-width-card">
                <h2 class="card-title">Analysis Problem</h2>
                <div class="report-content-wrapper">
                    {{ report_content|safe }}
                </div>
                <p style="margin-top: 15px;">Please check the <a href="{{ url_for('analysis_logs') }}">analysis logs</a> for more details, or contact support if the issue persists, referencing Log ID: {{ log_id if log_id else "N/A" }}.</p>
            </section>
        {% elif report_content %}
            {# Full report content generated by analysis_engine.py will be rendered here #}
            {# It includes overview, AI sections, schema, previews with legend, and categorized anomalies #}
            {{ report_content|safe }}

            {# Fallback Previews if not part of report_content (should be, but as safety) #}
            {# These are less likely to be used if report_content is comprehensive #}
            {% if new_preview and 'new_data_preview_table' not in report_content %}
            <div class="card data-preview-card-fallback" style="margin-top:20px;">
                 <h3 class="card-title">Initial Data Previews (Fallback)</h3>
                <details class="collapsible-section" open>
                    <summary>Preview: New Data (Initial Snapshot)</summary>
                    <div class="preview-table-container table-responsive-wrapper">
                        {{ new_preview|safe }}
                    </div>
                </details>
                 {% if historic_preview and "No historic data preview available" not in historic_preview %}
                <details class="collapsible-section">
                    <summary>Preview: Historic Data Sample (Initial Snapshot)</summary>
                    <div class="preview-table-container table-responsive-wrapper">
                            {{ historic_preview|safe }}
                    </div>
                </details>
                {% endif %}
            </div>
            {% endif %}

        {% else %}
             <section class="card no-data-card full-width-card">
                <h2 class="card-title">No Report Content</h2>
                <p>The analysis did not produce a report. This might be due to an early error or no data to process.</p>
                {% if log_id and log_id != "N/A" and log_id is not none %}
                <p>Please check the <a href="{{ url_for('analysis_logs') }}">analysis logs</a> using Log ID: <strong>{{ log_id }}</strong>.</p>
                {% else %}
                <p>Please check the <a href="{{ url_for('analysis_logs') }}">analysis logs</a> for recent entries.</p>
                {% endif %}
            </section>
        {% endif %}
    </main>

    <footer class="page-footer">
        <p>Â© {{ SCRIPT_LOAD_TIME.year if SCRIPT_LOAD_TIME else '' }} Data Monitoring Tool.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Table styling (Bootstrap-like classes if not applied by Python)
            document.querySelectorAll('.preview-table-container table, .results-section table, .dataset-comparison-card table, .report-container table.result-table').forEach(table => {
                if (!table.classList.contains('table')) table.classList.add('table');
                if (!table.classList.contains('table-sm')) table.classList.add('table-sm');
                if (!table.classList.contains('table-striped')) table.classList.add('table-striped');
                if (!table.classList.contains('table-hover')) table.classList.add('table-hover');
                // Add accessible captions if missing
                if (!table.querySelector('caption')) {
                    const caption = table.createCaption();
                    const parentCardTitle = table.closest('.card,.report-section')?.querySelector('.card-title, h3, h4');
                    caption.textContent = parentCardTitle?.textContent.trim() || 'Data Table';
                    caption.classList.add('sr-only'); // Visually hide, but available for screen readers
                }
                table.querySelectorAll('thead th').forEach(th => th.setAttribute('scope', 'col'));
            });

            // "Show more anomalies" link functionality
            const showMoreLinks = document.querySelectorAll('.show-more-anomalies-link');
            showMoreLinks.forEach(link => {
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    const targetId = this.dataset.targetId;
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        const isHidden = targetElement.style.display === 'none';
                        targetElement.style.display = isHidden ? 'block' : 'none';
                        this.textContent = isHidden ? this.textContent.replace('Click to see', 'Click to hide') : this.textContent.replace('Click to hide', 'Click to see');
                        if(isHidden) {
                             targetElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }
                });
            });

            // Collapsible sections (if any outside of Python-generated content)
            const detailsElements = document.querySelectorAll('details.collapsible-section');
            detailsElements.forEach(details => {
                // Could add custom open/close logic if needed
            });
        });
    </script>
    <style>
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
        .nav-link-button { /* Simple button-like link */
            display: inline-block;
            padding: 8px 15px;
            background-color: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: var(--border-radius-sm);
            transition: background-color 0.2s;
        }
        .nav-link-button:hover {
            background-color: var(--primary-hover-color);
        }
    </style>
</body>
</html>